#!/bin/bash

# Update the system
sudo yum update -y
sudo reboot

# Disable firewall and Selinux to permissive (no reboot required)
sudo systemctl stop firewalld && sudo systemctl disable firewalld && sudo setenforce 0 && sudo sed -i 's/^SELINUX=.*/SELINUX=permissive/g' /etc/selinux/config

# Install Java 11
sudo yum install java-11-openjdk java-11-openjdk-devel -y

# Add Tomcat group
sudo groupadd tomcat

# Create tomcat user, disable login and give rights
sudo useradd -s /bin/nologin -g tomcat -d /opt/tomcat tomcat

# Install WGET
sudo yum -y install wget

# Download Tomcat 10.0.22
VER=10.0.22
wget https://archive.apache.org/dist/tomcat/tomcat-10/v${VER}/bin/apache-tomcat-${VER}.tar.gz

# Wait for Tomcat to start
until curl --silent --fail http://localhost:8080/ > /dev/null; do
    printf '.'
    sleep 5
done
echo "Tomcat is now running."

# Extract to /opt/tomcat directory
sudo tar -xvf apache-tomcat-$VER.tar.gz -C /opt/tomcat --strip-components=1

# Allow Tomcat user to access the files in tomcat directory
sudo chown -R tomcat: /opt/tomcat

# Make the scripts in the directory executable
sudo sh -c 'chmod +x /opt/tomcat/bin/*.sh'

# Create the systemd config file
sudo bash -c 'cat << EOF > /etc/systemd/system/tomcat.service
[Unit]
Description=Apache Tomcat Web Application Container
Wants=network.target
After=network.target

[Service]
Type=forking

Environment=JAVA_HOME=/usr/lib/jvm/java-11-openjdk-11.0.19.0.7-1.el9_1.x86_64
Environment=CATALINA_PID=/opt/tomcat/temp/tomcat.pid
Environment=CATALINA_HOME=/opt/tomcat
Environment='CATALINA_OPTS=-Xms512M -Xmx1G -Djava.net.preferIPv4Stack=true'
Environment='JAVA_OPTS=-Djava.awt.headless=true'

ExecStart=/opt/tomcat/bin/startup.sh
ExecStop=/opt/tomcat/bin/shutdown.sh
SuccessExitStatus=143

User=tomcat
Group=tomcat
UMask=0007
RestartSec=10
Restart=always

[Install]
WantedBy=multi-user.target
EOF'

# Start and Enable the tomcat service
sudo systemctl daemon-reload
sudo systemctl enable --now tomcat
