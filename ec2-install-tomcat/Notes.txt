# Make sure terraform is installed
https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli
# Make sure aws cli is installed 
https://devopsmania.com/how-to-install-aws-cli-v2-on-linux/
# Make sure Java is installed too 
java -version

Note: DO not use Amazon Linux 2023 as amazon extras not available 

# How to know java home?
java -XshowSettings:properties -version 2>&1 > /dev/null | grep 'java.home'
Output: java.home = /usr/lib/jvm/java-11-openjdk-11.0.18.0.10-1.amzn2.0.1.x86_64

Install Java and Tomcat 10? 
https://techviewleo.com/how-to-install-apache-tomcat-on-rhel-centos/
Java 11 - sudo yum install java-11-openjdk java-11-openjdk-devel -y
Java 8 - sudo yum install java-1.8.0-openjdk java-1.8.0-openjdk-devel -y 

How to access the default tomcat page? 
54.208.144.246:8080

Note: Make sure you can ssh manually to the target server before doing terraform apply 


To know an issue: 
export TF_LOG=DEBUG
terraform apply

# edit the /opt/tomcat/conf/tomcat-users.xml to append the following
	<role rolename="manager-gui"/>
	<role rolename="manager-script"/>
	<role rolename="manager-jmx"/>
	<role rolename="manager-status"/>
	<user username="admin" password="admin" roles="manager-gui, manager-script, manager-jmx, manager-status"/>
	<user username="deployer" password="deployer" roles="manager-script"/>
	<user username="tomcat" password="s3cret" roles="manager-gui"/>

# edit the /opt/tomcat/webapps/manager/META-INF/context.xml => this is to allowe access to Manager App from all. 
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="^.*$"/[?4m

Whole content:
context.xml 
###########
<?xml version="1.0" encoding="UTF-8"?>
<Context antiResourceLocking="false" privileged="true" >
  <CookieProcessor className="org.apache.tomcat.util.http.Rfc6265CookieProcessor"
                   sameSiteCookies="strict" />
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="^.*$"/[?4m
  <Manager sessionAttributeValueClassNameFilter="java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap"/>
</Context>


# edit the /opt/tomcat/webapps/host-manager/META-INF/context.xml ==> this is for host-manager (optional)
<version="1.0" encoding="UTF-8"?>
<Context antiResourceLocking="false" privileged="true" >
  <CookieProcessor className="org.apache.tomcat.util.http.Rfc6265CookieProcessor"
                   sameSiteCookies="strict" />
<Valve className="org.apache.catalina.valves.RemoteAddrValve"
       allow="^.*$"/>
  <Manager sessionAttributeValueClassNameFilter="java\.lang\.(?:Boolean|Integer|Long|Number|String)|org\.apache\.catalina\.filters\.CsrfPreventionFilter\$LruCache(?:\$1)?|java\.util\.(?:Linked)?HashMap"/>

# edit /opt/tomcat/conf/server.xml (for host-manager still)
<Host name="localhost" appBase="webapps"
      unpackWARs="true" autoDeploy="true">
      
      <!-- Add this line if it's missing -->
      <Context path="/host-manager" docBase="${catalina.home}/webapps/host-manager"
               privileged="true" antiResourceLocking="false"
               antiJARLocking="false">
               <Valve className="org.apache.catalina.valves.RemoteAddrValve"
                      allow="^.*$" />
      </Context>

